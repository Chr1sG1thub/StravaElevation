<!DOCTYPE html>
<html>
<head><title>Strava Elevation - Proxy</title></head>
<body>
<script src='https://unpkg.com/@turf/turf@7.0.0/turf.min.js'></script>
<script>
async function calculateElevationGain(trackpoints) {
  const coords = trackpoints.map(([lat, lon]) => [lon, lat]);
  let line = turf.lineString(coords);
  
  let tolerance = 0.0001;
  while (line.geometry.coordinates.length > 100) {
    line = turf.simplify(line, { tolerance, highQuality: false });
    tolerance *= 1.2;
  }
  
  const locations = line.geometry.map(([lon, lat]) => `${lat.toFixed(6)},${lon.toFixed(6)}`).join('|');
  const url = `https://corsproxy.io/?${encodeURIComponent(
    `https://api.opentopodata.org/v1/copernicus?locations=${locations}&interpolation=bilinear`
  )}`;
  
  try {
    const response = await fetch(url);
    const data = await response.json();
    
    const elevations = data.results
      .map(r => r.elevation)
      .filter(e => e !== null && !isNaN(e));
    
    let gain = 0, threshold = 0.5;
    for (let i = 1; i < elevations.length; i++) {
      const delta = elevations[i] - elevations[i-1];
      if (delta > threshold) gain += delta;
    }
    
    document.body.innerHTML += `
      <h1>✅ Elevation gain: ${Math.round(gain)}m</h1>
      <p>${trackpoints.length} → ${elevations.length} points</p>
    `;
  } catch (err) {
    document.body.innerHTML += `<h1>❌ Error: ${err.message}</h1>`;
  }
}

calculateElevationGain([
  [42.5432, 2.4167], [42.5500, 2.4200], 
  [42.5600, 2.4300], [42.5700, 2.4400],
  [42.5800, 2.4450], [42.6000, 2.4500]
]);
</script>
</body>
</html>
