<!DOCTYPE html>
<html>
<head><title>Strava Elevation</title></head>
<body>
<script src='https://unpkg.com/@turf/turf@7.0.0/turf.min.js'></script>
<script>
// ✅ JSONP version - works in all browsers
function calculateElevationGainJSONP(trackpoints, callback) {
  const coords = trackpoints.map(([lat, lon]) => [lon, lat]);
  let line = turf.lineString(coords);
  
  let tolerance = 0.0001;
  while (line.geometry.coordinates.length > 100) {
    line = turf.simplify(line, { tolerance, highQuality: false });
    tolerance *= 1.2;
  }
  
  const locations = line.geometry.coordinates
    .map(([lon, lat]) => `${lat.toFixed(6)},${lon.toFixed(6)}`)
    .join('|');
    
  const script = document.createElement('script');
  script.src = `https://api.opentopodata.org/v1/eudem25m?locations=${locations}&interpolation=bilinear&jsonp=${callback}`;
  document.head.appendChild(script);
  
  // Global callback handler
  window.handleElevationData = function(results) {
    const elevations = results.results
      .map(r => r.elevation)
      .filter(e => e !== null && !isNaN(e));
    
    if (elevations.length < 2) {
      callback({error: 'Insufficient elevation data'}, 0);
      return;
    }
    
    let gain = 0, threshold = 0.5;
    for (let i = 1; i < elevations.length; i++) {
      const delta = elevations[i] - elevations[i - 1];
      if (delta > threshold) gain += delta;
    }
    
    callback({
      totalGain: Math.round(gain),
      pointsUsed: elevations.length,
      originalPoints: trackpoints.length
    }, tolerance);
  };
}

function main() {
  const sampleTrack = [
    [42.5432, 2.4167, 350], [42.5500, 2.4200, 360],
    [42.5600, 2.4300, 450], [42.5700, 2.4400, 600],
    [42.5800, 2.4450, 700], [42.6000, 2.4500, 800]
  ];

  calculateElevationGainJSONP(sampleTrack, (result, tolerance) => {
    if (result.error) {
      document.body.innerHTML += `<h1>Error: ${result.error}</h1>`;
    } else {
      document.body.innerHTML += `
        <h1>Elevation gain: ${result.totalGain}m</h1>
        <p>${result.originalPoints} → ${result.pointsUsed} points</p>
        <p>Tolerance: ${tolerance.toFixed(6)}</p>
      `;
      console.log(result);
    }
  });
}

main();
</script>
</body>
</html>
